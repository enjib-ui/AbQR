<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Absensi Multitenancy</title>
<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
body, html {margin:0;padding:0;font-family:"Poppins",sans-serif;background:#f0f2ff;}
.sidebar {width:240px;background:#7494ec;color:#fff;flex-shrink:0;display:flex;flex-direction:column;padding:20px 0;position:fixed;height:100vh;transition: transform 0.3s;}
.sidebar h2{text-align:center;margin-bottom:10px;font-size:20px;}
.sidebar p{font-size:13px;text-align:center;margin-bottom:30px;color:#e0e0ff;}
.sidebar a{color:#fff;padding:12px 20px;display:flex;align-items:center;gap:10px;text-decoration:none;transition:.3s;}
.sidebar a:hover{background:rgba(255,255,255,0.2);}
.sidebar .logout{margin-top:auto;color:#f8d7da;}
.content {margin-left:240px;padding:15px;transition: margin-left 0.3s;}
.content h1{color:#333;margin-bottom:15px;font-size:18px;}
.card{background:#fff;padding:15px;margin-bottom:15px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);}
.form-group{margin-bottom:12px;}
.form-group label{display:block;margin-bottom:5px;font-weight:500;}
.form-group input{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px;}
.btn-save{background:#7494ec;color:#fff;padding:10px 15px;border:none;border-radius:8px;cursor:pointer;font-weight:600;margin-top:5px;font-size:14px;}
.btn-save:hover{background:#5a78c7;}
#reader{width:100%;max-width:400px;margin:10px auto;}
.popup{position:fixed;top:15px;right:15px;background:#4caf50;color:#fff;padding:10px 15px;border-radius:8px;display:none;z-index:999;}
.absensi-list{margin-top:15px;max-height:250px;overflow-y:auto;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid #ddd;padding:6px;text-align:center;font-size:13px;}
th{background:#f2f2f2;}
@media screen and (max-width:768px){
  .sidebar{position:fixed;transform:translateX(-100%);z-index:2000;}
  .close-btn {
  font-size: 24px;
  color: #fff;
  text-align: right;
  padding: 0 15px;
  cursor: pointer;
  margin-bottom: 15px;
  }
  
  .sidebar.show{transform:translateX(0);}
  .content{margin-left:0;}
  .menu-toggle{position:fixed;top:10px;left:10px;font-size:24px;cursor:pointer;color:#7494ec;z-index:999;}
  .sidebar.show {
    transform: translateX(0); /* muncul saat toggle */
  }
  .content { margin-left:0; }
  .menu-toggle {
    position: fixed;
    top: 10px;
    left: 10px;
    font-size: 24px;
    cursor: pointer;
    color: #7494ec;
    z-index: 2100; /* pastikan di atas sidebar */
  }
    
}
</style>
</head>
<body>
<div class="menu-toggle" onclick="toggleMenu()">&#9776;</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <div class="close-btn" onclick="closeSidebar()">&#10005;</div> <!-- X -->
  <h2>Dashboard</h2>
  <p>Logged in as <br><span id="userEmail"></span></p>
  <a href="#" onclick="showPage('addStudent')"><i class='bx bxs-user-plus'></i>Tambah Siswa</a>
  <a href="#" onclick="showPage('scanQr')"><i class='bx bx-qr-scan'></i>Scan QR</a>
  <a href="#" onclick="showPage('absensiData')"><i class='bx bxs-report'></i>Data Absensi</a>
  <a href="#" id="logoutBtn" class="logout"><i class='bx bx-log-out'></i>Logout</a>
</div>

<!-- Content -->
<div class="content" id="content">

  <!-- Tambah Siswa -->
  <div id="addStudentPage" class="page">
    <h1>Tambah Siswa</h1>
    <div class="card">
      <form id="addStudentForm">
        <div class="form-group"><label>Nama Siswa</label><input type="text" id="studentName" required></div>
        <div class="form-group"><label>Kelas</label><input type="text" id="studentClass" required></div>
        <div class="form-group"><label>Pelajaran</label><input type="text" id="studentSubject" required></div>
        <div class="form-group"><label>Nama Sekolah</label><input type="text" id="studentSchool" required></div>
        <button type="submit" class="btn-save">Simpan</button>
      </form>
      <div style="margin-top:10px;">
        <input type="file" id="importFile" accept=".xlsx">
        <button type="button" class="btn-save" onclick="importSiswa()">Import Excel</button>
      </div>
    </div>

    <div class="card">
      <button type="button" class="btn-save" onclick="exportSiswa()">Export Excel</button>
      <h3>Data Siswa</h3>
      <table>
        <thead>
          <tr>
            <th>Nama</th>
            <th>Kelas</th>
            <th>Pelajaran</th>
            <th>Nama Sekolah</th>
            <th>QR Code</th>
          </tr>
        </thead>
        <tbody id="siswaTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Scan QR -->
  <div id="scanQrPage" class="page" style="display:none;">
    <h1>Scan QR</h1>
    <div class="card">
      <div id="reader"></div>
      <div class="absensi-list">
        <h3>Data Absensi Real-time</h3>
        <ul id="scanResult"></ul>
      </div>
    </div>
  </div>

  <!-- Data Absensi -->
  <div id="absensiDataPage" class="page" style="display:none;">
    <h1>Data Absensi</h1>
    <div class="card">
      <label for="filterDate">Filter Tanggal:</label>
      <input type="date" id="filterDate">
      <button class="btn-save" onclick="loadAbsensi()">Filter</button>
      <button class="btn-save" onclick="exportAbsensi()">Export Excel</button>
    </div>
    <div class="card">
      <table>
        <thead><tr><th>Nama</th><th>Kelas</th><th>Email</th><th>Waktu</th></tr></thead>
        <tbody id="absensiTable"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="popup" class="popup">Berhasil Masuk</div>

<!-- Firebase + JS -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBKFobPaqznvZdOMCXCh9D4d9jVEopq6DQ",
  authDomain: "abqr-7ec2a.firebaseapp.com",
  projectId: "abqr-7ec2a",
  storageBucket: "abqr-7ec2a.firebasestorage.app",
  messagingSenderId: "908334703141",
  appId: "1:908334703141:web:3dad64af321d59f55395cc"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let tenantId = null;

// Login check
onAuthStateChanged(auth, user => {
  if(user){
    tenantId = user.uid; // tenant = user login
    document.getElementById("userEmail").innerText = user.email;
    loadSiswa(); // load siswa saat login
  } else {
    window.location.href = "index.html";
  }
});

// Logout
document.getElementById("logoutBtn").addEventListener("click", e=>{
  e.preventDefault(); signOut(auth).then(()=>window.location.href="index.html");
});

// Toggle mobile menu
function toggleMenu(){document.getElementById("sidebar").classList.toggle("show");}

window.toggleMenu = toggleMenu;
document.querySelectorAll('.sidebar a').forEach(link => {
  link.addEventListener('click', () => {
    if(window.innerWidth <= 768){
      document.getElementById('sidebar').classList.remove('show');
    }
});
});
  function closeSidebar() {
  document.getElementById('sidebar').classList.remove('show');
  }
  
  

// Switch page
function showPage(page){
  document.querySelectorAll(".page").forEach(p => p.style.display = "none");
  document.getElementById(page + "Page").style.display = "block";
  if(page === "scanQr") startScanner();
  if(page === "addStudent") loadSiswa();
}
window.showPage = showPage;

// Load siswa multitenancy
async function loadSiswa(){
  if(!tenantId) return;
  const tbody = document.getElementById("siswaTable");
  tbody.innerHTML = "";
  const snap = await getDocs(collection(db, `tenants/${tenantId}/siswa`));
  snap.forEach(docSnap => {
    const d = docSnap.data();
    addSiswaRow(docSnap.id, d.nama, d.kelas, d.pelajaran, d.sekolah);
  });
}
window.loadSiswa = loadSiswa;

// Tambah siswa manual
document.addEventListener("DOMContentLoaded", () => {
  const addStudentForm = document.getElementById('addStudentForm');
  addStudentForm.addEventListener('submit', async e => {
    e.preventDefault();
    if(!tenantId) return;
    const name = document.getElementById("studentName").value.trim();
    const kelas = document.getElementById("studentClass").value.trim();
    const subject = document.getElementById("studentSubject").value.trim();
    const school = document.getElementById("studentSchool").value.trim();
    if(!name || !kelas || !subject || !school) return alert("Lengkapi semua field!");

    // Cek duplikat berdasarkan nama+kelas
    const snap = await getDocs(collection(db, `tenants/${tenantId}/siswa`));
    const exists = snap.docs.some(d => d.data().nama===name && d.data().kelas===kelas);
    if(exists) return showPopup("Siswa sudah ada!");

    const docRef = await addDoc(collection(db, `tenants/${tenantId}/siswa`), {
      nama: name, kelas: kelas, pelajaran: subject, sekolah: school
    });

    addSiswaRow(docRef.id, name, kelas, subject, school);
    addStudentForm.reset();
    showPopup("Siswa berhasil ditambahkan!");
  });
});

// Import Excel
async function importSiswa(){
  if(!tenantId) return;
  const file = document.getElementById("importFile").files[0];
  if(!file){alert("Pilih file dulu");return;}
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data);
  const ws = wb.Sheets[wb.SheetNames[0]];
  const json = XLSX.utils.sheet_to_json(ws);
  for(let row of json){
    if(row.Nama && row.Kelas && row.Pelajaran && row.Sekolah){
      const snap = await getDocs(collection(db, `tenants/${tenantId}/siswa`));
      const exists = snap.docs.some(d => d.data().nama===row.Nama && d.data().kelas===row.Kelas);
      if(exists) continue;
      const docRef = await addDoc(collection(db, `tenants/${tenantId}/siswa`), {
        nama: row.Nama, kelas: row.Kelas, pelajaran: row.Pelajaran, sekolah: row.Sekolah
      });
      addSiswaRow(docRef.id, row.Nama, row.Kelas, row.Pelajaran, row.Sekolah);
    }
  }
  showPopup("Import Excel selesai!");
}

// Tambah row + QR (cek duplikat di tabel)
function addSiswaRow(id, nama, kelas, pelajaran, sekolah){
  const tbody = document.getElementById("siswaTable");
  // Cek apakah sudah ada di tabel
  const exists = Array.from(tbody.children).some(tr => tr.children[0].innerText===nama && tr.children[1].innerText===kelas);
  if(exists) return;
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${nama}</td>
    <td>${kelas}</td>
    <td>${pelajaran}</td>
    <td>${sekolah}</td>
    <td id="qr-${id}"></td>
  `;
  tbody.prepend(tr);
  new QRCode(document.getElementById(`qr-${id}`), { text: id, width:64, height:64 });
}

// Scan QR
function startScanner(){
  if(!tenantId) return;
  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start({facingMode:"environment"}, {fps:10, qrbox:250}, async decodedText=>{
    const docRef = doc(db, `tenants/${tenantId}/siswa`, decodedText);
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()){
      const data = docSnap.data();
      await addDoc(collection(db, `tenants/${tenantId}/absensi`), {
        nama: data.nama, kelas: data.kelas, email: data.email||"", waktu: new Date()
      });
      showPopup("Berhasil Masuk");
      const li = document.createElement("li");
      li.textContent = `${data.nama} - ${data.kelas} - ${new Date().toLocaleTimeString()}`;
      document.getElementById("scanResult").prepend(li);
    }
  }, ()=>{});
}

// Popup
function showPopup(msg){
  const popup = document.getElementById("popup");
  popup.textContent = msg;
  popup.style.display = "block";
  setTimeout(()=>popup.style.display="none", 2000);
}

// Load Absensi
async function loadAbsensi(){
  if(!tenantId) return;
  const date = document.getElementById("filterDate").value;
  const tbody = document.getElementById("absensiTable");
  tbody.innerHTML = "";
  const q = query(collection(db, `tenants/${tenantId}/absensi`), orderBy("waktu","desc"));
  const snap = await getDocs(q);
  snap.forEach(docSnap=>{
    const data = docSnap.data();
    const waktu = new Date(data.waktu.seconds*1000).toLocaleString();
    if(!date || waktu.startsWith(new Date(date).toLocaleDateString())){
      const tr = document.createElement("tr");
      tr.innerHTML=`<td>${data.nama}</td><td>${data.kelas}</td><td>${data.email}</td><td>${waktu}</td>`;
      tbody.appendChild(tr);
    }
  });
}
window.loadAbsensi = loadAbsensi;

// Export Absensi
async function exportAbsensi(){
  if(!tenantId) return;
  const snap = await getDocs(collection(db, `tenants/${tenantId}/absensi`));
  const dataArr=[];
  snap.forEach(docSnap=>{
    const d = docSnap.data();
    dataArr.push({Nama:d.nama,Kelas:d.kelas,Email:d.email,Waktu:new Date(d.waktu.seconds*1000).toLocaleString()});
  });
  const ws = XLSX.utils.json_to_sheet(dataArr);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Absensi");
  XLSX.writeFile(wb, "DataAbsensi.xlsx");
}

// Export Siswa
async function exportSiswa(){
  if(!tenantId) return;
  const snap = await getDocs(collection(db, `tenants/${tenantId}/siswa`));
  const dataArr = [];
  snap.forEach(docSnap=>{
    const d = docSnap.data();
    dataArr.push({Nama:d.nama,Kelas:d.kelas,Pelajaran:d.pelajaran,Sekolah:d.sekolah,QRCodeID:docSnap.id});
  });
  const ws = XLSX.utils.json_to_sheet(dataArr);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Siswa");
  XLSX.writeFile(wb, "DataSiswa.xlsx");
}

window.exportSiswa = exportSiswa;
window.exportAbsensi = exportAbsensi;

</script>
</body>
                                               </html>
                                               
